---
phase: 01-foundation-discovery
plan: 05
type: execute
wave: 3
depends_on: ["01-03", "01-04"]
files_modified:
  - src/cli/index.ts
  - src/cli/init.ts
  - src/cli/discover.ts
autonomous: true

must_haves:
  truths:
    - "Running `ar init` creates default config file"
    - "Running `ar discover` lists files to analyze"
    - "Running `ar discover --quiet` produces minimal output"
    - "Gitignore patterns are respected during discovery"
    - "Binary files are excluded from discovery"
    - "Vendor directories are excluded from discovery"
  artifacts:
    - path: "src/cli/index.ts"
      provides: "CLI entry point with command routing"
      contains: "#!/usr/bin/env node"
    - path: "src/cli/init.ts"
      provides: "ar init command"
      exports: ["initCommand"]
    - path: "src/cli/discover.ts"
      provides: "ar discover command"
      exports: ["discoverCommand"]
  key_links:
    - from: "src/cli/discover.ts"
      to: "src/discovery/walker.ts"
      via: "import walkDirectory"
      pattern: "import.*walkDirectory"
    - from: "src/cli/discover.ts"
      to: "src/discovery/filters/index.ts"
      via: "import applyFilters"
      pattern: "import.*applyFilters"
    - from: "src/cli/init.ts"
      to: "src/config/loader.ts"
      via: "import writeDefaultConfig"
      pattern: "import.*writeDefaultConfig"
---

<objective>
Create the CLI commands that expose the discovery functionality to users.

Purpose: This is the user-facing interface. `ar init` creates configuration, `ar discover` runs file discovery with all filters applied. This plan wires together all the pieces from Plans 01-04.

Output: Working CLI that users can run to discover files in their repositories.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-discovery/01-CONTEXT.md
@.planning/phases/01-foundation-discovery/01-RESEARCH.md
@.planning/phases/01-foundation-discovery/01-01-SUMMARY.md
@.planning/phases/01-foundation-discovery/01-02-SUMMARY.md
@.planning/phases/01-foundation-discovery/01-03-SUMMARY.md
@.planning/phases/01-foundation-discovery/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create init command</name>
  <files>src/cli/init.ts</files>
  <action>
Create src/cli/init.ts:

Import { configExists, writeDefaultConfig } from '../config/loader.js'.
Import { createLogger } from '../output/logger.js'.

Export interface InitOptions:
- interactive: boolean (reserved for future --interactive flag)

Export async function initCommand(root: string, options: InitOptions): Promise<void>
- Check if config already exists with configExists()
- If exists: log warning "Config already exists at .agents-reverse/config.yaml" and return
- Call writeDefaultConfig(root)
- Log success message with path to created file
- Mention user can edit the file to customize exclusions

Handle errors:
- If directory creation fails, log error and exit with code 1
- Provide helpful message about permissions
  </action>
  <verify>
`npm run build` succeeds.
Manual test after full CLI is working in Task 3.
  </verify>
  <done>
initCommand creates config file or warns if exists. Provides helpful success/error messages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create discover command</name>
  <files>src/cli/discover.ts</files>
  <action>
Create src/cli/discover.ts:

Import { walkDirectory } from '../discovery/walker.js'.
Import { applyFilters, createGitignoreFilter, createVendorFilter, createBinaryFilter, createCustomFilter } from '../discovery/filters/index.js'.
Import { loadConfig } from '../config/loader.js'.
Import { createLogger } from '../output/logger.js'.
Import path.

Export interface DiscoverOptions:
- quiet: boolean
- showExcluded: boolean
- verbose: boolean (derived: true unless quiet)

Export async function discoverCommand(targetPath: string, options: DiscoverOptions): Promise<void>

Implementation:
1. Resolve targetPath to absolute (default to cwd)
2. Load config with loadConfig(targetPath)
3. Create logger with options derived from CLI flags and config
4. Log "Discovering files in {path}..."

5. Create filters in order:
   - gitignore filter (await createGitignoreFilter)
   - vendor filter with config.exclude.vendorDirs
   - binary filter with config.options.maxFileSize
   - custom filter with config.exclude.patterns

6. Walk directory with walkDirectory({ cwd: targetPath })
7. Apply filters with applyFilters(files, filters)

8. Log results:
   - If verbose: log each included file with logger.file()
   - If showExcluded: log each excluded file with logger.excluded()
   - Always: log summary with logger.summary()

9. Exit with code 0 on success

Handle errors:
- If targetPath doesn't exist: log error, exit 1
- If permission denied: log warning, continue with partial results
  </action>
  <verify>
`npm run build` succeeds.
Manual test after CLI entry point created in Task 3.
  </verify>
  <done>
discoverCommand loads config, runs discovery with filters, outputs results according to options.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CLI entry point</name>
  <files>src/cli/index.ts</files>
  <action>
Create src/cli/index.ts:

Add shebang: #!/usr/bin/env node

Import { initCommand } from './init.js'.
Import { discoverCommand } from './discover.js'.

Parse arguments manually (no external arg parser for simplicity):
- args[0]: command name (init, discover)
- args[1+]: positional args and flags

Supported commands per CONTEXT.md:
- init [--interactive]: Create default config
- discover [path] [--quiet] [--show-excluded]: Discover files

Parse flags:
- --quiet or -q: Set quiet mode
- --show-excluded: Show each excluded file
- --help or -h: Show usage

Implementation:
1. Get command from process.argv[2]
2. Parse remaining args for path and flags
3. Route to appropriate command function
4. Handle unknown commands with usage help

Usage help text:
```
agents-reverse - AI-friendly codebase documentation

Commands:
  init              Create default configuration
  discover [path]   Discover files to analyze (default: current directory)

Options:
  --quiet, -q       Suppress output except errors
  --show-excluded   List each excluded file
  --help, -h        Show this help

Examples:
  ar init
  ar discover
  ar discover ./my-project --quiet
```

Make executable:
- Ensure shebang is first line
- After build, run `chmod +x dist/cli/index.js` (note: npm handles this via bin field)
  </action>
  <verify>
`npm run build` succeeds.
Test CLI: `node dist/cli/index.js --help` shows usage.
Test init: `node dist/cli/index.js init` creates .agents-reverse/config.yaml.
Test discover: `node dist/cli/index.js discover` outputs discovered files.
Test quiet: `node dist/cli/index.js discover --quiet` produces minimal output.
  </verify>
  <done>
CLI entry point routes commands correctly. All flags work. Help text is helpful.
  </done>
</task>

</tasks>

<verification>
Full end-to-end tests:

1. `npm run build` succeeds
2. `node dist/cli/index.js --help` shows usage with all commands
3. `node dist/cli/index.js init` creates .agents-reverse/config.yaml
4. `node dist/cli/index.js init` (again) warns config exists
5. `node dist/cli/index.js discover` outputs file list with colors
6. `node dist/cli/index.js discover --quiet` outputs only errors (if any)
7. `node dist/cli/index.js discover --show-excluded` shows excluded files with reasons

Test requirements:
- Create test repo with .gitignore containing "*.log"
- Add test.log file
- Run discover, verify test.log is in excluded list with "gitignore" as reason
- Add node_modules/foo.js (or use existing)
- Verify it's excluded with "vendor" reason
- Add test.png
- Verify it's excluded with "binary" reason
</verification>

<success_criteria>
- `ar init` creates working config
- `ar discover` finds files and excludes noise
- All four requirement criteria met:
  1. .gitignore patterns respected (DISC-01)
  2. Binary files excluded (DISC-02)
  3. Vendor directories excluded (DISC-03)
  4. Custom patterns from config excluded (DISC-04)
- CLI provides helpful output and error messages
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-discovery/01-05-SUMMARY.md`
</output>
