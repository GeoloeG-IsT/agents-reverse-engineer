---
phase: 04-integration-commands
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/integration/generate.ts
  - src/cli/init.ts
  - src/cli/index.ts
autonomous: true

must_haves:
  truths:
    - "ar init --integration creates command files for detected environments"
    - "Existing files are not overwritten without confirmation"
    - "Init reports which files were created vs skipped"
  artifacts:
    - path: "src/integration/generate.ts"
      provides: "Integration file generation logic"
      exports: ["generateIntegrationFiles"]
    - path: "src/cli/init.ts"
      provides: "Init command with --integration support"
      exports: ["initCommand", "InitOptions"]
    - path: "src/cli/index.ts"
      provides: "CLI router with integration flag"
      contains: "flags.has('integration')"
  key_links:
    - from: "src/integration/generate.ts"
      to: "src/integration/detect.ts"
      via: "environment detection"
      pattern: "detectEnvironments"
    - from: "src/integration/generate.ts"
      to: "src/integration/templates.ts"
      via: "template retrieval"
      pattern: "getClaudeTemplates|getOpenCodeTemplates"
    - from: "src/cli/init.ts"
      to: "src/integration/generate.ts"
      via: "integration flag handler"
      pattern: "generateIntegrationFiles"
---

<objective>
Create the integration file generation logic and update the CLI init command to support --integration flag.

Purpose: Users can run `ar init --integration` to set up command files for their AI coding assistant, enabling /are:generate and /are:update slash commands.

Output:
- `src/integration/generate.ts` - Logic to create integration files
- Updated `src/cli/init.ts` - Support --integration flag
- Updated `src/cli/index.ts` - Route --integration flag
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-commands/04-RESEARCH.md
@.planning/phases/04-integration-commands/04-CONTEXT.md
@src/cli/init.ts
@src/cli/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration file generator</name>
  <files>src/integration/generate.ts</files>
  <action>
Create `src/integration/generate.ts` with:

1. `generateIntegrationFiles(projectRoot: string, options: GenerateOptions): Promise<IntegrationResult[]>` function:

   ```typescript
   interface GenerateOptions {
     dryRun?: boolean;
     force?: boolean;  // Overwrite existing files
   }
   ```

   Logic:
   - Call `detectEnvironments(projectRoot)` to find AI assistants
   - For each detected environment:
     - Get appropriate templates (getClaudeTemplates or getOpenCodeTemplates)
     - For each template:
       - Compute full path: path.join(projectRoot, template.path)
       - If file exists and not force: add to skipped
       - Else: create directories (mkdirSync recursive), write file
     - For Claude: also generate hook file and note that settings.json needs manual update
   - Return IntegrationResult[] with created/skipped files

2. Helper `ensureDir(filePath: string)`:
   - Create parent directories if they don't exist
   - Use mkdirSync with recursive: true

3. For Claude hook:
   - Write hook file to `.claude/hooks/are-session-end.js`
   - Content from getHookTemplate()

Import from:
- `./types.js` for types
- `./detect.js` for detectEnvironments
- `./templates.js` for template getters
- `node:fs` for writeFileSync, existsSync, mkdirSync
- `node:path` for path operations
  </action>
  <verify>
`npx tsc --noEmit` passes. Manual verification after build:
```bash
npm run build && node -e "
import { generateIntegrationFiles } from './dist/integration/generate.js';
generateIntegrationFiles('/tmp/test-project', { dryRun: true }).then(console.log);
"
```
Should return empty array (no environments detected in /tmp/test-project).
  </verify>
  <done>
generateIntegrationFiles function exists and returns IntegrationResult[] with created/skipped file lists
  </done>
</task>

<task type="auto">
  <name>Task 2: Update init command to support --integration</name>
  <files>src/cli/init.ts</files>
  <action>
Update `src/cli/init.ts`:

1. Update InitOptions interface:
   ```typescript
   export interface InitOptions {
     interactive?: boolean;
     integration?: boolean;  // NEW: Generate integration files
   }
   ```

2. In initCommand function, after creating config file:
   - If options.integration:
     - Import and call generateIntegrationFiles
     - Log results: "Created: {files}" and "Skipped (already exist): {files}"
     - For Claude, remind about settings.json: "Note: Add SessionEnd hook to .claude/settings.json manually"

3. Update success message to mention integration option:
   ```typescript
   if (!options.integration) {
     logger.info('Run with --integration to set up AI assistant commands');
   }
   ```

Use dynamic import for integration module to avoid circular dependencies:
```typescript
const { generateIntegrationFiles } = await import('../integration/generate.js');
```
  </action>
  <verify>
`npx tsc --noEmit` passes. Check that InitOptions now includes integration field:
```bash
npm run build && node -e "import('./dist/cli/init.js').then(m => console.log('initCommand:', typeof m.initCommand))"
```
  </verify>
  <done>
InitOptions includes integration field, initCommand calls generateIntegrationFiles when flag is true
  </done>
</task>

<task type="auto">
  <name>Task 3: Update CLI router for --integration flag</name>
  <files>src/cli/index.ts</files>
  <action>
Update `src/cli/index.ts`:

1. Update USAGE string to document --integration flag:
   ```
   Options:
     ...
     --integration     Generate AI assistant command files (init only)
   ```

2. In the init case of the switch statement:
   ```typescript
   case 'init': {
     const options: InitOptions = {
       interactive: flags.has('interactive'),
       integration: flags.has('integration'),  // NEW
     };
     await initCommand(positional[0] || '.', options);
     break;
   }
   ```

3. Update Examples section:
   ```
   Examples:
     ar init
     ar init --integration
     ar discover
     ...
   ```
  </action>
  <verify>
`npx tsc --noEmit` passes. Verify help shows new flag:
```bash
npm run build && node dist/cli/index.js --help | grep integration
```
Should show "--integration" in output.
  </verify>
  <done>
`ar --help` shows --integration flag, `ar init --integration` routes correctly to init with integration: true
  </done>
</task>

</tasks>

<verification>
All checks pass:
1. `npx tsc --noEmit` - No TypeScript errors
2. `npm run build` - Build succeeds
3. `ar --help` shows --integration option
4. `ar init --integration --dry-run` in a test directory attempts to generate integration files
</verification>

<success_criteria>
- src/integration/generate.ts exports generateIntegrationFiles
- InitOptions includes integration boolean
- CLI routes --integration flag to init command
- Running `ar init --integration` in a project with .claude/ creates command files
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-commands/04-02-SUMMARY.md`
</output>
