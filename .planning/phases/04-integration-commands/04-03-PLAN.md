---
phase: 04-integration-commands
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .claude/commands/ar/generate.md
  - .claude/commands/ar/update.md
  - .claude/commands/ar/init.md
  - .claude/hooks/ar-session-end.js
  - .claude/settings.json
autonomous: true

must_haves:
  truths:
    - "User can run /ar:generate in Claude Code to analyze project"
    - "User can run /ar:update in Claude Code to update changed files"
    - "User can run /ar:init to initialize configuration"
    - "SessionEnd hook triggers ar update when session closes"
    - "Hook is silent when no changes exist"
  artifacts:
    - path: ".claude/commands/ar/generate.md"
      provides: "/ar:generate slash command"
      contains: "ar generate"
    - path: ".claude/commands/ar/update.md"
      provides: "/ar:update slash command"
      contains: "ar update"
    - path: ".claude/commands/ar/init.md"
      provides: "/ar:init slash command"
      contains: "ar init"
    - path: ".claude/hooks/ar-session-end.js"
      provides: "SessionEnd hook for auto-updates"
      contains: "ar.*update"
    - path: ".claude/settings.json"
      provides: "Hook registration"
      contains: "ar-session-end.js"
  key_links:
    - from: ".claude/commands/ar/generate.md"
      to: "ar generate CLI"
      via: "bash command"
      pattern: "ar generate"
    - from: ".claude/hooks/ar-session-end.js"
      to: "git status"
      via: "pre-check"
      pattern: "git status --porcelain"
---

<objective>
Create the Claude Code integration files for THIS project - command files and session-end hook.

Purpose: Enables /ar:generate, /ar:update, and /ar:init commands in Claude Code for this project, plus automatic documentation updates when sessions end.

Output:
- `.claude/commands/ar/generate.md` - Generate command
- `.claude/commands/ar/update.md` - Update command
- `.claude/commands/ar/init.md` - Init command
- `.claude/hooks/ar-session-end.js` - Session-end hook
- Updated `.claude/settings.json` - Hook registration
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-commands/04-RESEARCH.md
@.planning/phases/04-integration-commands/04-CONTEXT.md
@.claude/settings.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Claude Code command files</name>
  <files>.claude/commands/ar/generate.md, .claude/commands/ar/update.md, .claude/commands/ar/init.md</files>
  <action>
Create `.claude/commands/ar/` directory and three command files:

1. `.claude/commands/ar/generate.md`:
```markdown
---
name: ar:generate
description: Generate AI-friendly documentation for the entire codebase
argument-hint: "[--budget N] [--dry-run] [--verbose]"
---

Generate comprehensive documentation for this codebase using agents-reverse.

<execution>
Run the agents-reverse generate command:

\`\`\`bash
ar generate $ARGUMENTS
\`\`\`

After completion, summarize:
- Number of files analyzed
- Token budget used
- Any files skipped due to budget
- Location of generated CLAUDE.md and AGENTS.md files

If budget concerns arise, suggest \`--budget N\` to adjust.
</execution>
```

2. `.claude/commands/ar/update.md`:
```markdown
---
name: ar:update
description: Incrementally update documentation for changed files
argument-hint: "[--uncommitted] [--dry-run] [--verbose]"
---

Update documentation for files that changed since last run.

<execution>
Run the agents-reverse update command:

\`\`\`bash
ar update $ARGUMENTS
\`\`\`

After completion, summarize:
- Files updated
- Files unchanged
- Any orphaned docs cleaned up

Use \`--uncommitted\` to include staged but uncommitted changes.
</execution>
```

3. `.claude/commands/ar/init.md`:
```markdown
---
name: ar:init
description: Initialize agents-reverse configuration and integration
argument-hint: "[--integration]"
---

Initialize agents-reverse in this project.

<execution>
Run the agents-reverse init command:

\`\`\`bash
ar init $ARGUMENTS
\`\`\`

This creates:
- \`.agents-reverse.yaml\` configuration file
- With \`--integration\`: command files for detected AI assistants
</execution>
```
  </action>
  <verify>
Files exist and have correct frontmatter:
```bash
ls -la .claude/commands/ar/
head -10 .claude/commands/ar/generate.md
```
  </verify>
  <done>
Three command files exist in .claude/commands/ar/ with proper YAML frontmatter and execution instructions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create session-end hook</name>
  <files>.claude/hooks/ar-session-end.js</files>
  <action>
Create `.claude/hooks/ar-session-end.js`:

```javascript
#!/usr/bin/env node
/**
 * Session-end hook for agents-reverse
 * Triggers ar update when session ends (if there are uncommitted changes)
 *
 * Disable temporarily: AR_DISABLE_HOOK=1
 * Disable permanently: Set hook_enabled: false in .agents-reverse.yaml
 */

const { execSync, spawn } = require('child_process');
const fs = require('fs');
const path = require('path');

// Check for disable environment variable
if (process.env.AR_DISABLE_HOOK === '1') {
  process.exit(0);
}

// Check config file for permanent disable
const configPath = path.join(process.cwd(), '.agents-reverse.yaml');
if (fs.existsSync(configPath)) {
  try {
    const config = fs.readFileSync(configPath, 'utf-8');
    if (config.includes('hook_enabled: false')) {
      process.exit(0);
    }
  } catch {
    // Ignore config read errors
  }
}

// Check git status - skip if no changes
try {
  const status = execSync('git status --porcelain', {
    encoding: 'utf-8',
    timeout: 5000,
  });
  if (!status.trim()) {
    // No changes - exit silently
    process.exit(0);
  }
} catch {
  // Not a git repo or git not available - exit silently
  process.exit(0);
}

// Check if ar CLI is available
try {
  execSync('which ar', { encoding: 'utf-8', timeout: 2000 });
} catch {
  // ar CLI not in PATH - exit silently
  // User hasn't installed agents-reverse globally
  process.exit(0);
}

// Run update in background (don't block session close)
try {
  const child = spawn('ar', ['update', '--quiet'], {
    stdio: 'ignore',
    detached: true,
  });
  child.unref();
} catch {
  // Spawn failed - exit silently
  process.exit(0);
}
```

Make executable:
```bash
chmod +x .claude/hooks/ar-session-end.js
```
  </action>
  <verify>
```bash
ls -la .claude/hooks/ar-session-end.js
head -20 .claude/hooks/ar-session-end.js
```
File exists and is executable, starts with shebang.
  </verify>
  <done>
Hook file exists, is executable, checks git status before spawning ar update
  </done>
</task>

<task type="auto">
  <name>Task 3: Update settings.json with SessionEnd hook</name>
  <files>.claude/settings.json</files>
  <action>
Read existing `.claude/settings.json` and add SessionEnd hook registration.

Current content has SessionStart hook. Add SessionEnd to hooks object:

```json
{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "node .claude/hooks/gsd-check-update.js"
          }
        ]
      }
    ],
    "SessionEnd": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "node \"$CLAUDE_PROJECT_DIR\"/.claude/hooks/ar-session-end.js"
          }
        ]
      }
    ]
  },
  "statusLine": {
    "type": "command",
    "command": "node .claude/hooks/gsd-statusline.js"
  }
}
```

Use $CLAUDE_PROJECT_DIR to ensure correct path resolution.
  </action>
  <verify>
```bash
cat .claude/settings.json | grep -A5 SessionEnd
```
Should show SessionEnd hook registration pointing to ar-session-end.js
  </verify>
  <done>
settings.json includes SessionEnd hook that runs ar-session-end.js
  </done>
</task>

</tasks>

<verification>
All Claude Code integration files in place:
1. `ls .claude/commands/ar/` shows generate.md, update.md, init.md
2. `.claude/hooks/ar-session-end.js` exists and is executable
3. `.claude/settings.json` has SessionEnd hook registration
4. Command files have valid YAML frontmatter (name, description, argument-hint)
</verification>

<success_criteria>
- /ar:generate command available in Claude Code (file exists with proper frontmatter)
- /ar:update command available in Claude Code
- /ar:init command available in Claude Code
- SessionEnd hook registered and will trigger ar update on session close
- Hook is silent when no git changes or when disabled
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-commands/04-03-SUMMARY.md`
</output>
